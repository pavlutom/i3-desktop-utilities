#!/bin/zsh

# define some constants
HW_LOWEST=140;		KEY_LOWEST='lowest'
HW_LOW=400;			KEY_LOW='low'
HW_MEDIUM=1500;		KEY_MEDIUM='medium'
HW_HIGH=12000;		KEY_HIGH='high'
HW_MAX=24000;		KEY_MAX='max'

# load hardware
source ~/.scripts/.display/.names

# get requested value
REQ=$1
if [[ $REQ == $KEY_LOWEST ]]; then
	HW_REQ=$HW_LOWEST
elif [[ $REQ == $KEY_LOW ]]; then
	HW_REQ=$HW_LOW
elif [[ $REQ == $KEY_MEDIUM ]]; then
	HW_REQ=$HW_MEDIUM
elif [[ $REQ == $KEY_HIGH ]]; then
	HW_REQ=$HW_HIGH
elif [[ $REQ == $KEY_MAX ]]; then
	HW_REQ=$HW_MAX
fi

# set special value if requested
if [[ $HW_REQ ]]; then
	# set xrandr to 100%
	xrandr --output $M0 --brightness 1
	# use hardware
	brightnessctl --device=intel_backlight set $HW_REQ
	# notify
	dunstify -u 0 -t 1500 "Brightness set to $REQ"

	exit 0
fi

# init
BR=$(~/.scripts/.utils/parsepercent $1)
FRAC=$(($BR / 100.0))

# get hw brightness value
zmodload zsh/mathfunc
integer HW_BR=$(( rint($FRAC * $HW_MAX) ))

# if we can use laptop display backlight
if [[ $BR -ge 0 && $BR -le 100 ]]; then
	# set xrandr to 100%
	xrandr --output $M0 --brightness 1
	# use hardware
	brightnessctl --device=intel_backlight set $HW_BR
	echo actual: $HW_BR percent: $BR
else
	# set hardware to 100%
	echo $HW_MAX > /sys/class/backlight/intel_backlight/brightness
	# use xrandr
	xrandr --output $M0 --brightness $FRAC
fi

# external monitors (always using xrandr)
xrandr --output $M1 --brightness $FRAC
xrandr --output $M2 --brightness $FRAC

# notify
dunstify -u 0 -t 1500 "Brightness $BR%"
